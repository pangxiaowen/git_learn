## 交互式暂存

如果您使用 `-i` 或 `--interactive` 选项运行 `git add`，Git 将进入交互式 shell 模式，显示类似于以下内容

git add -i

## 暂存和取消暂存文件

如果您在 `What now>` 提示符下键入 `u` 或 `2`（用于更新），系统将提示您输入要暂存的文件

每个文件旁边的 `*` 表示该文件已选中要暂存。如果您在 `Update>>` 提示符下不输入任何内容并按 Enter，Git 将暂存所有选中的文件

如果您想此时取消暂存文件，您可以使用 `r` 或 `3`（用于还原）选项

要查看已暂存内容的差异，您可以使用 `d` 或 `6`（用于差异）命令。

使用这些基本命令，您可以使用交互式添加模式更轻松地处理暂存区域。

## 暂存补丁

Git 也可以暂存文件的特定部分，而不是其他部分。例如，如果您在 `simplegit.rb` 文件中进行了两次修改，并且想要暂存其中一个，而不是另一个，在 Git 中执行此操作非常简单。

在 Git 中，暂存补丁（Staging Patches）通常指通过 git add -p（或 --patch）命令，交互式地选择部分修改内容暂存到暂存区，而不是一次性暂存所有更改。这种方式可以让你将代码修改拆分成更小的逻辑单元，保持提交历史的清晰性。

在 Git 中，**暂存补丁**（Staging Patches）通常指通过 `git add -p`（或 `--patch`）命令，**交互式地选择部分修改内容暂存到暂存区**，而不是一次性暂存所有更改。这种方式可以让你将代码修改拆分成更小的逻辑单元，保持提交历史的清晰性。

---

### **1. 核心用途**
- **精细化提交**：将同一文件中的不同修改拆分成多个提交。
- **过滤无用代码**：避免将调试代码或临时修改提交到仓库。
- **解决冲突后选择性暂存**：合并冲突时仅暂存需要的部分。

---

### **2. 操作步骤**
#### **(1) 启动交互式暂存**
```bash
git add -p  # 或 git add --patch <文件名>
```
Git 会逐个显示代码块（称为 **hunk**），并提示你选择操作。

#### **(2) 选择如何处理每个 hunk**
当看到一个 hunk 时，Git 会显示以下选项：
```
Stage this hunk [y,n,q,a,d,s,e,?]?
```
常用选项：
- **`y`**：暂存当前 hunk。
- **`n`**：跳过当前 hunk。
- **`s`**：将当前 hunk **拆分**为更小的块（适用于一个 hunk 包含多个逻辑修改）。
- **`e`**：手动编辑当前 hunk（高级用法，需熟悉 diff 格式）。
- **`q`**：退出，保留已暂存的内容。
- **`?`**：查看帮助。

#### **(3) 重复操作直到完成**
处理完所有 hunk 后，使用 `git status` 确认暂存内容，然后提交：
```bash
git commit -m "描述"
```

---

### **3. 示例场景**
假设你修改了 `app.js`，其中包含两个功能：
1. 修复登录逻辑（第 10-15 行）。
2. 添加用户统计功能（第 20-25 行）。

通过 `git add -p app.js`，可以：
- 先选择暂存登录逻辑的 hunk（按 `y`）。
- 提交第一个功能：`git commit -m "修复登录逻辑"`。
- 再次运行 `git add -p app.js`，暂存用户统计的 hunk。
- 提交第二个功能：`git commit -m "添加用户统计"`。

---

### **4. 高级技巧**
#### **(1) 手动编辑 hunk（`e` 选项）**
- 如果自动拆分的 hunk 不准确，可以按 `e` 进入编辑模式，直接修改 diff 内容。
- 删除不需要的行（以 `-` 或 `+` 开头的行），保留要暂存的部分。

#### **(2) 反向操作：取消暂存部分内容**
```bash
git reset -p  # 交互式取消暂存
```

#### **(3) 直接丢弃部分修改**
```bash
git checkout -p  # 交互式丢弃工作区修改
```

---

### **5. 注意事项**
- **拆分 hunk 的准确性**：确保每个 hunk 对应一个逻辑修改，避免提交不完整的功能。
- **冲突风险**：如果修改涉及多个文件，需确保暂存后的代码能通过编译或测试。
- **备份修改**：复杂操作前建议先 `git stash` 保存当前状态。

---

### **6. 替代工具**
- **GUI 工具**：
  使用 `git gui` 或 IDE 内置的 Git 工具（如 VS Code 的源代码管理界面），通过可视化界面选择代码块。
- **命令行别名**：
  简化命令，例如将 `git add -p` 设为别名 `gap`：
  ```bash
  git config --global alias.gap 'add -p'
  ```

---

### **总结**
| **场景**               | **命令**              | **目的**                     |
|-------------------------|-----------------------|------------------------------|
| 暂存部分修改           | `git add -p`          | 精细化提交                   |
| 取消部分暂存内容       | `git reset -p`        | 修正暂存错误                 |
| 丢弃部分工作区修改     | `git checkout -p`     | 清理不需要的代码             |
| 手动编辑 hunk          | `git add -e`          | 精确控制暂存内容             |

通过 `git add -p`，你可以像拼图一样构建高质量的提交历史，让代码变更更易读、更易维护。